<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>러닝크루 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .team-score {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .milk { color: #8b5cf6; }
        .grape { color: #6366f1; }
        button {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #059669;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        textarea {
            height: 100px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .warning { background: #fef3c7; color: #92400e; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f9fafb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏆 러닝크루 대결 (테스트 버전)</h1>
        
        <!-- 상태 확인 -->
        <div class="section">
            <h2>📊 시스템 상태</h2>
            <div id="system-status">시스템 로딩 중...</div>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                ⚠️ <strong>중요:</strong> 로컬 파일에서는 CORS 제한으로 구글 시트 접근이 불가능합니다.<br>
                📁 <strong>해결책:</strong> GitHub Pages나 다른 웹 호스팅에 배포하세요.
            </div>
        </div>

        <!-- 팀 점수 -->
        <div class="section">
            <h2>🏃‍♂️ 팀별 점수</h2>
            <div class="team-score milk">🥛 우유팀: <span id="milk-score">0</span> km</div>
            <div class="team-score grape">🍇 포도팀: <span id="grape-score">0</span> km</div>
        </div>

        <!-- 데이터 연결 -->
        <div class="section">
            <h2>📊 데이터 연결</h2>
            <input type="url" id="csvUrl" placeholder="CSV URL 입력" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQSxKnN2BUIBcbNrpywGy2F_YjLnzWjabSOSCO_Kmwnq-mvia1E6g4ezt5nwwEj-3CWblrJO1xjaLTk/pub?output=csv">
            <button onclick="testLoadData()">데이터 로드 테스트</button>
            <div id="data-status"></div>
        </div>

        <!-- Forms 연결 -->
        <div class="section">
            <h2>📝 Forms 연결</h2>
            <textarea id="formsEmbed" placeholder="Forms 임베드 코드 입력"><iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfToqiLU4-8Ckl23xO3y_r6dvjSDheU6TgALlvd2QT0e0na-Q/viewform?embedded=true" width="100%" height="400" frameborder="0">로드 중...</iframe></textarea>
            <button onclick="testEmbedForms()">Forms 연결 테스트</button>
            <div id="forms-status"></div>
            <div id="forms-container" style="border: 1px solid #ccc; height: 400px; margin: 10px 0;">
                Forms가 여기에 표시됩니다
            </div>
        </div>

        <!-- 기록 표시 -->
        <div class="section">
            <h2>📋 기록 현황</h2>
            <div>총 기록 수: <span id="record-count">0</span>개</div>
            <table>
                <thead>
                    <tr>
                        <th>크루원</th>
                        <th>팀</th>
                        <th>거리</th>
                        <th>날짜</th>
                    </tr>
                </thead>
                <tbody id="records-table">
                    <tr><td colspan="4">데이터를 로드해주세요</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 크루원 데이터
        const crewMembers = {
            '우유': ['goinggoing', 'JS Jeon', 'NJ_Run', '거북아달려', '검단이봉주', '겨자색슈즈', '돌아온빵꾸', '마커스', '먕먐', '물냉명', '봉무동러너', '삼남매맘', '상우쌍우', '세동이', '신욱재', '우유키', '후니'],
            '포도': ['권초게', '라꾸라꾸조깅', '마이세트', '뭉공주', '바다', '삐약비약', '수다맘', '술우', '얼쑤야', '윤호근', '이응내', '자달매', '정영준', '하늘은평', '하하하양', '해피러너', '후다닭']
        };
        
        let records = [];
        
        // 페이지 로드시 실행
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료');
            updateSystemStatus('✅ 시스템 로드 완료');
            
            // 로컬 테스트를 위한 더미 데이터 생성
            setTimeout(() => {
                console.log('더미 데이터 로드 시작');
                loadDummyData();
            }, 1000);
            
            // 실제 CSV도 시도
            setTimeout(() => {
                console.log('실제 데이터 로드 시도');
                testLoadData();
            }, 2000);
        });
        
        // 더미 데이터 로드 (테스트용)
        function loadDummyData() {
            console.log('더미 데이터 생성 중...');
            
            const dummyRecords = [
                { timestamp: '2025-01-15 10:30', userId: 'goinggoing', team: '우유', date: '2025-01-15', distance: 5.0 },
                { timestamp: '2025-01-15 11:00', userId: '권초게', team: '포도', date: '2025-01-15', distance: 3.5 },
                { timestamp: '2025-01-15 11:30', userId: '마커스', team: '우유', date: '2025-01-15', distance: 4.2 },
                { timestamp: '2025-01-15 12:00', userId: '바다', team: '포도', date: '2025-01-15', distance: 6.1 },
                { timestamp: '2025-01-15 12:30', userId: '봉무동러너', team: '우유', date: '2025-01-15', distance: 7.3 }
            ];
            
            records = dummyRecords;
            console.log('더미 데이터 로드됨:', records);
            
            showStatus('data-status', 'success', `더미 데이터 ${records.length}개 로드됨 (테스트용)`);
            updateSystemStatus('✅ 더미 데이터 로드 완료');
            updateUI();
        }
        
        // 시스템 상태 업데이트
        function updateSystemStatus(message) {
            document.getElementById('system-status').textContent = message;
            console.log('시스템 상태:', message);
        }
        
        // 상태 메시지 표시
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            console.log(`${elementId}:`, message);
        }
        
        // 사용자 팀 찾기
        function findUserTeam(userId) {
            for (const [team, members] of Object.entries(crewMembers)) {
                if (members.includes(userId)) {
                    return team;
                }
            }
            return null;
        }
        
        // 데이터 로드 테스트
        async function testLoadData() {
            console.log('데이터 로드 시작');
            updateSystemStatus('📊 데이터 로드 중...');
            
            const csvUrl = document.getElementById('csvUrl').value;
            console.log('CSV URL:', csvUrl);
            
            if (!csvUrl) {
                showStatus('data-status', 'error', 'CSV URL이 없습니다');
                return;
            }
            
            try {
                showStatus('data-status', 'warning', '데이터 로드 중...');
                
                console.log('Fetch 시작');
                const response = await fetch(csvUrl);
                console.log('Response:', response);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('CSV 데이터 받음, 길이:', csvText.length);
                console.log('CSV 첫 500자:', csvText.substring(0, 500));
                
                records = parseCSV(csvText);
                console.log('파싱된 레코드:', records);
                
                showStatus('data-status', 'success', `${records.length}개 기록 로드 성공!`);
                updateSystemStatus('✅ 데이터 로드 완료');
                updateUI();
                
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                showStatus('data-status', 'error', `로드 실패: ${error.message}`);
                updateSystemStatus('❌ 데이터 로드 실패');
            }
        }
        
        // CSV 파싱
        function parseCSV(csvText) {
            console.log('CSV 파싱 시작');
            const lines = csvText.trim().split('\n');
            console.log('CSV 라인 수:', lines.length);
            
            if (lines.length <= 1) {
                console.log('데이터가 없음');
                return [];
            }
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = line.split(',');
                console.log(`라인 ${i}:`, columns);
                
                if (columns.length >= 4) {
                    const timestamp = columns[0] || '';
                    const userId = columns[1] || '';
                    const date = columns[3] || '';
                    const distance = columns[4] || '';
                    
                    if (userId && distance && !isNaN(parseFloat(distance))) {
                        const team = findUserTeam(userId.trim());
                        console.log(`${userId} -> ${team}`);
                        
                        if (team) {
                            data.push({
                                timestamp,
                                userId: userId.trim(),
                                team,
                                date: date.trim(),
                                distance: parseFloat(distance.trim())
                            });
                        }
                    }
                }
            }
            
            console.log('파싱 완료, 데이터 수:', data.length);
            return data;
        }
        
        // Forms 임베드 테스트
        function testEmbedForms() {
            console.log('Forms 임베드 시작');
            
            const embedCode = document.getElementById('formsEmbed').value;
            console.log('임베드 코드:', embedCode);
            
            if (!embedCode) {
                showStatus('forms-status', 'error', 'Forms 코드가 없습니다');
                return;
            }
            
            try {
                const container = document.getElementById('forms-container');
                container.innerHTML = embedCode;
                showStatus('forms-status', 'success', 'Forms 연결 성공!');
                console.log('Forms 임베드 완료');
            } catch (error) {
                console.error('Forms 임베드 실패:', error);
                showStatus('forms-status', 'error', `Forms 연결 실패: ${error.message}`);
            }
        }
        
        // UI 업데이트
        function updateUI() {
            console.log('UI 업데이트 시작');
            updateTeamScores();
            updateRecordsTable();
        }
        
        // 팀 점수 업데이트
        function updateTeamScores() {
            const totals = { '우유': 0, '포도': 0 };
            records.forEach(r => {
                totals[r.team] += r.distance;
            });
            
            document.getElementById('milk-score').textContent = totals['우유'].toFixed(1);
            document.getElementById('grape-score').textContent = totals['포도'].toFixed(1);
            
            console.log('팀 점수 업데이트:', totals);
        }
        
        // 기록 테이블 업데이트
        function updateRecordsTable() {
            const tbody = document.getElementById('records-table');
            const countEl = document.getElementById('record-count');
            
            countEl.textContent = records.length;
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">기록이 없습니다</td></tr>';
                return;
            }
            
            const recent = records.slice(-10).reverse();
            tbody.innerHTML = recent.map(r => `
                <tr>
                    <td>${r.userId}</td>
                    <td style="color: ${r.team === '우유' ? '#8b5cf6' : '#6366f1'}">${r.team}</td>
                    <td><strong>${r.distance}km</strong></td>
                    <td>${r.date}</td>
                </tr>
            `).join('');
            
            console.log('테이블 업데이트 완료');
        }
        
        // 전역 오류 핸들링
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('전역 오류:', msg, 'at', lineNo + ':' + columnNo);
            updateSystemStatus('❌ JavaScript 오류 발생');
            return false;
        };
        
        console.log('스크립트 로드 완료');
    </script>
</body>
</html>
